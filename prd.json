{
  "name": "Worktree Manager & Merge Reliability PRD",
  "description": "Improve worktree management and merge conflict resolution in the parallel execution system. Fixes critical bugs in conflict marker generation, worktree cleanup, and lock management.",
  "branchName": "feature/worktree-reliability",
  "userStories": [
    {
      "id": "US-001",
      "title": "Fix Duplicate Conflict Marker Generation",
      "description": "- As a developer, I want merge conflict resolution to not produce duplicate conflict markers - So that resolved files are valid code",
      "acceptanceCriteria": [
        "resolveSimpleConflict() must not produce <<<<<<<, =======, >>>>>>> markers",
        "Simple conflicts (additions only) should be auto-merged cleanly",
        "Complex conflicts must fall back to LLM resolution, not produce invalid output",
        "Test coverage for conflict resolution patterns"
      ],
      "priority": 1,
      "passes": false,
      "labels": ["bugfix", "worktree", "merge"],
      "dependsOn": []
    },
    {
      "id": "US-002",
      "title": "Worktree Cleanup on Shutdown",
      "description": "- As a system, I want all worktrees to be properly cleaned up when the coordinator stops - So that orphaned directories don't accumulate",
      "acceptanceCriteria": [
        "Coordinator shutdown hook removes all worker worktrees",
        "Coordinator shutdown hook removes merge worktree",
        "Errors during cleanup are logged with context",
        "Cleanup is idempotent (safe to call multiple times)",
        "Manual cleanup command available via CLI"
      ],
      "priority": 1,
      "passes": false,
      "labels": ["reliability", "worktree", "cleanup"],
      "dependsOn": ["ralph-tui-wmr.1"]
    },
    {
      "id": "US-003",
      "title": "Worktree Validation After Creation",
      "description": "- As a system, I want to verify worktrees are created correctly - So that failures are detected early",
      "acceptanceCriteria": [
        "WorktreeManager validates branch after creation",
        "WorktreeManager validates commit is on expected branch",
        "Validation errors include path, expected vs actual state",
        "Retry with force flag for stale worktree state"
      ],
      "priority": 2,
      "passes": false,
      "labels": ["validation", "worktree", "reliability"],
"dependsOn": ["ralph-tui-wmr.2"]
      },
      {
        "id": "US-004",
      "title": "Lock Timeout for Stale Workers",
      "description": "- As a system, I want worktree locks to auto-expire - So that crashed workers don't leave permanently locked worktrees",
      "acceptanceCriteria": [
        "Lock metadata includes timestamp",
        "Periodic check for locks older than N minutes (default: 30)",
        "Auto-unlock stale locks with warning log",
        "Configurable timeout via config.toml",
        "Warning logged when auto-unlock occurs"
      ],
      "priority": 2,
      "passes": false,
      "labels": ["worktree", "locks", "reliability"],
      "dependsOn": ["ralph-tui-wmr.3"]
    },
    {
      "id": "US-005",
      "title": "Worktree Health Dashboard",
      "description": "- As a user, I want to see worktree health status in the dashboard - So that I can monitor parallel execution reliability",
      "acceptanceCriteria": [
        "Dashboard shows: active worktrees, locked worktrees, stale worktrees",
        "Health status indicator (healthy/warning/critical)",
        "Manual prune button in settings or dashboard",
        "Worktree count in run summary overlay"
      ],
      "priority": 2,
      "passes": false,
      "labels": ["ui", "dashboard", "worktree"],
      "dependsOn": ["ralph-tui-wmr.4"]
    },
    {
      "id": "US-006",
      "title": "Improved Merge Error Messaging",
      "description": "- As a user, I want clear error messages when merges fail - So that I can understand and fix issues",
      "acceptanceCriteria": [
        "Error messages include: conflict files, commit hash, task ID",
        "Suggestion for manual resolution when applicable",
        "Stack trace cleaned for user-facing output",
        "Error categorization: conflict/timeout/remote/network"
      ],
      "priority": 3,
      "passes": false,
      "labels": ["ux", "errors", "merge"],
      "dependsOn": ["ralph-tui-wmr.1"]
    },
    {
      "id": "US-007",
      "title": "Worktree Performance Optimization",
      "description": "- As a user, I want faster worktree operations - So that parallel execution has less overhead",
      "acceptanceCriteria": [
        "Worktree creation < 500ms for local repos",
        "Parallel worktree creation for multiple workers",
        "Cached git operations where possible",
        "Benchmark tests for worktree operations"
      ],
      "priority": 3,
      "passes": false,
      "labels": ["performance", "worktree", "optimization"],
      "dependsOn": ["ralph-tui-wmr.2"]
    }
  ],
  "metadata": {
    "createdAt": "2026-01-23T19:30:00.000Z",
    "version": "1.0.0",
    "sourcePrd": "tasks/prd-worktree-reliability.md"
  }
}
